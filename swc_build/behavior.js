"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.behavior=void 0;var _observers,_rfdc=_interopRequireDefault(require("rfdc")),_fastDeepEqual=_interopRequireDefault(require("fast-deep-equal")),dataPath=_interopRequireWildcard(require("./data-path")),dataTracer=_interopRequireWildcard(require("./data-tracer"));function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var d={};if(null!=a){for(var b in a)if(Object.prototype.hasOwnProperty.call(a,b)){var e=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,b):{};e.get||e.set?Object.defineProperty(d,b,e):d[b]=a[b]}}return d.default=a,d}var deepClone=_rfdc.default({proto:!0}),computedWatchDefIdInc=0,behavior=Behavior({lifetimes:{attached:function(){this.setData({_computedWatchInit:"attached"})},created:function(){this.setData({_computedWatchInit:"created"})}},definitionFilter:function(f){var g=f.computed,h=f.watch,i=[],j=computedWatchDefIdInc++;i.push({fields:"_computedWatchInit",observer:function(){var k=this.data._computedWatchInit;if("created"===k){var l={computedUpdaters:[],computedRelatedPathValues:{},watchCurVal:{}};this._computedWatchInfo||(this._computedWatchInfo={}),this._computedWatchInfo[j]=l,h&&Object.keys(h).forEach((function(m){var n=dataPath.parseMultiDataPaths(m).map((function(o){var p=o.path,q=o.options,r=dataPath.getDataOnPath(this.data,p);return q.deepCmp?deepClone(r):r}).bind(this));l.watchCurVal[m]=n}).bind(this))}else if("attached"===k){var s=this._computedWatchInfo[j];g&&Object.keys(g).forEach((function(t){var u=g[t],v=[],w=u(dataTracer.create(this.data,v)),x=v.map((function(y){var z=y.path;return{path:z,value:dataPath.getDataOnPath(this.data,z)}}).bind(this));this.setData(_defineProperty({},t,dataTracer.unwrap(w))),s.computedRelatedPathValues[t]=x;var A=(function(){for(var B=s.computedRelatedPathValues[t],C=!1,D=0;D<B.length;D++){var E=B[D],F=E.path;if(E.value!==dataPath.getDataOnPath(this.data,F)){C=!0;break}}if(!C)return!1;var G=[],H=u(dataTracer.create(this.data,G));return this.setData(_defineProperty({},t,dataTracer.unwrap(H))),s.computedRelatedPathValues[t]=G,!0}).bind(this);s.computedUpdaters.push(A)}).bind(this))}}}),g&&i.push({fields:"**",observer:function(){if(this._computedWatchInfo){var I,J=this._computedWatchInfo[j];if(J)do I=J.computedUpdaters.some((function(K){return K.call(this)}).bind(this));while(I)}}}),h&&Object.keys(h).forEach(function(L){var M=dataPath.parseMultiDataPaths(L);i.push({fields:L,observer:function(){if(this._computedWatchInfo){var N=this._computedWatchInfo[j];if(N){var O=N.watchCurVal[L],P=M.map((function(Q){var R=Q.path,S=Q.options;return{val:dataPath.getDataOnPath(this.data,R),options:S}}).bind(this)),T=P.map(function(U){var V=U.val;return U.options.deepCmp?deepClone(V):V});N.watchCurVal[L]=T;for(var W=!1,X=0;X<T.length;X++)if(M[X].options.deepCmp?!_fastDeepEqual.default(O[X],T[X]):O[X]!==T[X]){W=!0;break}W&&h[L].apply(this,P.map(function(Y){return Y.val}))}}}})}),"object"!=typeof f.observers&&(f.observers={}),Array.isArray(f.observers)?(_observers=f.observers).push.apply(_observers,i):i.forEach(function(Z){var $=f.observers[Z.fields];$?f.observers[Z.fields]=function(){Z.observer.call(this),$.call(this)}:f.observers[Z.fields]=Z.observer})}});exports.behavior=behavior