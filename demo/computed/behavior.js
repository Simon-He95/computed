"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.behavior=void 0;var ComputedWatchInitStatus,_observers,ComputedWatchInitStatus1,_rfdc=_interopRequireDefault(require("rfdc")),_fastDeepEqual=_interopRequireDefault(require("fast-deep-equal")),dataPath=_interopRequireWildcard(require("./data-path")),dataTracer=_interopRequireWildcard(require("./data-tracer"));function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var d={};if(null!=a){for(var b in a)if(Object.prototype.hasOwnProperty.call(a,b)){var e=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,b):{};e.get||e.set?Object.defineProperty(d,b,e):d[b]=a[b]}}return d.default=a,d}var deepClone=_rfdc.default({proto:!0});(ComputedWatchInitStatus=ComputedWatchInitStatus1||(ComputedWatchInitStatus1={}))[ComputedWatchInitStatus.CREATED=0]="CREATED",ComputedWatchInitStatus[ComputedWatchInitStatus.ATTACHED=1]="ATTACHED";var computedWatchDefIdInc=0,behavior=Behavior({lifetimes:{attached:function(){this.setData({_computedWatchInit:ComputedWatchInitStatus1.ATTACHED})},created:function(){this.setData({_computedWatchInit:ComputedWatchInitStatus1.CREATED})}},definitionFilter:function(f){var g=f.computed,h=f.watch,i=[],j=computedWatchDefIdInc++;i.push({fields:"_computedWatchInit",observer:function(){var k=this.data._computedWatchInit;if(k===ComputedWatchInitStatus1.CREATED){var l={computedUpdaters:[],computedRelatedPathValues:{},watchCurVal:{},_triggerFromComputedAttached:{}};this._computedWatchInfo||(this._computedWatchInfo={}),this._computedWatchInfo[j]=l,h&&Object.keys(h).forEach((function(m){var n=dataPath.parseMultiDataPaths(m).map((function(o){var p=o.path,q=o.options,r=dataPath.getDataOnPath(this.data,p);return q.deepCmp?deepClone(r):r}).bind(this));l.watchCurVal[m]=n}).bind(this))}else if(k===ComputedWatchInitStatus1.ATTACHED){var s=this._computedWatchInfo[j];g&&Object.keys(g).forEach((function(t){var u=g[t],v=[],w=u(dataTracer.create(this.data,v)),x=v.map((function(y){var z=y.path;return{path:z,value:dataPath.getDataOnPath(this.data,z)}}).bind(this));this.setData(_defineProperty({},t,dataTracer.unwrap(w))),s._triggerFromComputedAttached[t]=!0,s.computedRelatedPathValues[t]=x;var A=(function(){for(var B=s.computedRelatedPathValues[t],C=!1,D=0;D<B.length;D++){var E=B[D],F=E.path;if(E.value!==dataPath.getDataOnPath(this.data,F)){C=!0;break}}if(!C)return!1;var G=[],H=u(dataTracer.create(this.data,G));this.setData(_defineProperty({},t,dataTracer.unwrap(H)));var I=G.map((function(J){var K=J.path;return{path:K,value:dataPath.getDataOnPath(this.data,K)}}).bind(this));return s.computedRelatedPathValues[t]=I,!0}).bind(this);s.computedUpdaters.push(A)}).bind(this))}}}),g&&i.push({fields:"**",observer:function(){if(this._computedWatchInfo){var L,M=this._computedWatchInfo[j];if(M)do L=M.computedUpdaters.some((function(N){return N.call(this)}).bind(this));while(L)}}}),h&&Object.keys(h).forEach(function(O){var P=dataPath.parseMultiDataPaths(O);i.push({fields:O,observer:function(){if(this._computedWatchInfo){var Q=this._computedWatchInfo[j];if(Q){if(Object.keys(Q._triggerFromComputedAttached).length){var R={};for(var S in P.forEach(function(T){return R[T.path[0]]=!0}),Q._triggerFromComputedAttached)if(Q._triggerFromComputedAttached.hasOwnProperty(S)&&R[S]&&Q._triggerFromComputedAttached[S])return void(Q._triggerFromComputedAttached[S]=!1)}var U=Q.watchCurVal[O],V=P.map((function(W){var X=W.path,Y=W.options;return{val:dataPath.getDataOnPath(this.data,X),options:Y}}).bind(this)),Z=V.map(function($){var _=$.val;return $.options.deepCmp?deepClone(_):_});Q.watchCurVal[O]=Z;for(var aa=!1,ba=0;ba<Z.length;ba++)if(P[ba].options.deepCmp?!_fastDeepEqual.default(U[ba],Z[ba]):U[ba]!==Z[ba]){aa=!0;break}aa&&h[O].apply(this,V.map(function(ca){return ca.val}))}}}})}),"object"!=typeof f.observers&&(f.observers={}),Array.isArray(f.observers)?(_observers=f.observers).push.apply(_observers,i):i.forEach(function(da){var ea=f.observers[da.fields];ea?f.observers[da.fields]=function(){da.observer.call(this),ea.call(this)}:f.observers[da.fields]=da.observer})}});exports.behavior=behavior