"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.behavior=void 0;var _observers,_rfdc=_interopRequireDefault(require("rfdc")),_fastDeepEqual=_interopRequireDefault(require("fast-deep-equal")),dataPath=_interopRequireWildcard(require("./data-path")),dataTracer=_interopRequireWildcard(require("./data-tracer"));function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var d={};if(null!=a){for(var b in a)if(Object.prototype.hasOwnProperty.call(a,b)){var e=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,b):{};e.get||e.set?Object.defineProperty(d,b,e):d[b]=a[b]}}return d.default=a,d}var deepClone=_rfdc.default({proto:!0}),computedWatchDefIdInc=0,behavior=Behavior({lifetimes:{attached:function(){this.setData({_computedWatchInit:"attached"})},created:function(){this.setData({_computedWatchInit:"created"})}},definitionFilter:function(f){var g=f.computed,h=f.watch,i=[],j=computedWatchDefIdInc++;i.push({fields:"_computedWatchInit",observer:function(){var k=this.data._computedWatchInit;if("created"===k){var l={computedUpdaters:[],computedRelatedPathValues:{},watchCurVal:{},_triggerFromComputedAttached:{}};this._computedWatchInfo||(this._computedWatchInfo={}),this._computedWatchInfo[j]=l,h&&Object.keys(h).forEach((function(m){var n=dataPath.parseMultiDataPaths(m).map((function(o){var p=o.path,q=o.options,r=dataPath.getDataOnPath(this.data,p);return q.deepCmp?deepClone(r):r}).bind(this));l.watchCurVal[m]=n}).bind(this))}else if("attached"===k){var s=this._computedWatchInfo[j];g&&Object.keys(g).forEach((function(t){var u=g[t],v=[],w=u(dataTracer.create(this.data,v)),x=v.map((function(y){var z=y.path;return{path:z,value:dataPath.getDataOnPath(this.data,z)}}).bind(this));this.setData(_defineProperty({},t,dataTracer.unwrap(w))),s._triggerFromComputedAttached[t]=!0,s.computedRelatedPathValues[t]=x;var A=(function(){for(var B=s.computedRelatedPathValues[t],C=!1,D=0;D<B.length;D++){var E=B[D],F=E.path;if(E.value!==dataPath.getDataOnPath(this.data,F)){C=!0;break}}if(!C)return!1;var G=[],H=u(dataTracer.create(this.data,G));return this.setData(_defineProperty({},t,dataTracer.unwrap(H))),s.computedRelatedPathValues[t]=G,!0}).bind(this);s.computedUpdaters.push(A)}).bind(this))}}}),g&&i.push({fields:"**",observer:function(){if(this._computedWatchInfo){var I,J=this._computedWatchInfo[j];if(J)do I=J.computedUpdaters.some((function(K){return K.call(this)}).bind(this));while(I)}}}),h&&Object.keys(h).forEach(function(L){var M=dataPath.parseMultiDataPaths(L);i.push({fields:L,observer:function(){if(this._computedWatchInfo){var N=this._computedWatchInfo[j];if(N){if(Object.keys(N._triggerFromComputedAttached).length){var O={};for(var P in M.forEach(function(Q){return O[Q.path[0]]=!0}),N._triggerFromComputedAttached)if(N._triggerFromComputedAttached.hasOwnProperty(P)&&O[P]&&N._triggerFromComputedAttached[P])return void(N._triggerFromComputedAttached[P]=!1)}var R=N.watchCurVal[L],S=M.map((function(T){var U=T.path,V=T.options;return{val:dataPath.getDataOnPath(this.data,U),options:V}}).bind(this)),W=S.map(function(X){var Y=X.val;return X.options.deepCmp?deepClone(Y):Y});N.watchCurVal[L]=W;for(var Z=!1,$=0;$<W.length;$++)if(M[$].options.deepCmp?!_fastDeepEqual.default(R[$],W[$]):R[$]!==W[$]){Z=!0;break}Z&&h[L].apply(this,S.map(function(_){return _.val}))}}}})}),"object"!=typeof f.observers&&(f.observers={}),Array.isArray(f.observers)?(_observers=f.observers).push.apply(_observers,i):i.forEach(function(aa){var ba=f.observers[aa.fields];ba?f.observers[aa.fields]=function(){aa.observer.call(this),ba.call(this)}:f.observers[aa.fields]=aa.observer})}});exports.behavior=behavior