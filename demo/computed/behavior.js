"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.behavior=void 0;var _observers,_rfdc=_interopRequireDefault(require("rfdc")),_fastDeepEqual=_interopRequireDefault(require("fast-deep-equal")),dataPath=_interopRequireWildcard(require("./data-path")),dataTracer=_interopRequireWildcard(require("./data-tracer"));function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var d={};if(null!=a){for(var b in a)if(Object.prototype.hasOwnProperty.call(a,b)){var e=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,b):{};e.get||e.set?Object.defineProperty(d,b,e):d[b]=a[b]}}return d.default=a,d}var deepClone=_rfdc.default({proto:!0}),computedWatchDefIdInc=0,behavior=Behavior({lifetimes:{attached:function(){this.setData({_computedWatchInit:"attached"})},created:function(){this.setData({_computedWatchInit:"created"})}},definitionFilter:function(f){var g=f.computed,h=f.watch,i=[],j=computedWatchDefIdInc++;i.push({fields:"_computedWatchInit",observer:function(){var k=this.data._computedWatchInit;if("created"===k){var l={computedUpdaters:[],computedRelatedPathValues:{},watchCurVal:{},_triggerFromComputedAttached:{}};this._computedWatchInfo||(this._computedWatchInfo={}),this._computedWatchInfo[j]=l,h&&Object.keys(h).forEach((function(m){var n=dataPath.parseMultiDataPaths(m).map((function(o){var p=o.path,q=o.options,r=dataPath.getDataOnPath(this.data,p);return q.deepCmp?deepClone(r):r}).bind(this));l.watchCurVal[m]=n}).bind(this))}else if("attached"===k){var s=this._computedWatchInfo[j];g&&Object.keys(g).forEach((function(t){var u=g[t],v=[],w=u(dataTracer.create(this.data,v)),x=v.map((function(y){var z=y.path;return{path:z,value:JSON.stringify(dataPath.getDataOnPath(this.data,z))}}).bind(this));this.setData(_defineProperty({},t,dataTracer.unwrap(w))),s._triggerFromComputedAttached[t]=!0,s.computedRelatedPathValues[t]=x;var A=(function(){for(var B=s.computedRelatedPathValues[t],C=!1,D=0;D<B.length;D++){var E=B[D],F=E.path,G=E.value,H=dataPath.getDataOnPath(this.data,F);if(G!==JSON.stringify(H)){C=!0;break}}if(!C)return!1;var I=[],J=u(dataTracer.create(this.data,I)),K=I.map((function(L){var M=L.path;return{path:M,value:JSON.stringify(dataPath.getDataOnPath(this.data,M))}}).bind(this));return this.setData(_defineProperty({},t,dataTracer.unwrap(J))),s.computedRelatedPathValues[t]=K,!0}).bind(this);s.computedUpdaters.push(A)}).bind(this))}}}),g&&i.push({fields:"**",observer:function(){if(this._computedWatchInfo){var N,O=this._computedWatchInfo[j];if(O)do N=O.computedUpdaters.some((function(P){return P.call(this)}).bind(this));while(N)}}}),h&&Object.keys(h).forEach(function(Q){var R=dataPath.parseMultiDataPaths(Q);i.push({fields:Q,observer:function(){if(this._computedWatchInfo){var S=this._computedWatchInfo[j];if(S){if(Object.keys(S._triggerFromComputedAttached).length){var T={};for(var U in R.forEach(function(V){return T[V.path[0]]=!0}),S._triggerFromComputedAttached)if(Object.prototype.hasOwnProperty.call(S._triggerFromComputedAttached,U)&&T[U]&&S._triggerFromComputedAttached[U])return void(S._triggerFromComputedAttached[U]=!1)}var W=S.watchCurVal[Q],X=R.map((function(Y){var Z=Y.path,$=Y.options;return{val:dataPath.getDataOnPath(this.data,Z),options:$}}).bind(this)),_=X.map(function(aa){var ba=aa.val;return aa.options.deepCmp?deepClone(ba):ba});S.watchCurVal[Q]=_;for(var ca=!1,da=0;da<_.length;da++)if(R[da].options.deepCmp?!_fastDeepEqual.default(W[da],_[da]):W[da]!==_[da]){ca=!0;break}ca&&h[Q].apply(this,X.map(function(ea){return ea.val}))}}}})}),"object"!=typeof f.observers&&(f.observers={}),Array.isArray(f.observers)?(_observers=f.observers).push.apply(_observers,i):i.forEach(function(fa){var ga=f.observers[fa.fields];ga?f.observers[fa.fields]=function(){fa.observer.call(this),ga.call(this)}:f.observers[fa.fields]=fa.observer})}});exports.behavior=behavior